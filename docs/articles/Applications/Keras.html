<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grid Search Tuning of Keras Models • rsample</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="Grid Search Tuning of Keras Models">
<meta property="og:description" content="rsample">
<meta property="og:image" content="https://tidymodels.github.io/rsample/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../../index.html">rsample</a>
        <div class="info">
          <span class="partof">part of <a href="https://github.com/tidymodels">tidymodels</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.6</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../../articles/Basics.html">Basic Usage</a>
</li>
<li>
  <a href="../../articles/Working_with_rsets.html">Working with Resample Sets</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Application Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/Applications/Recipes_and_rsample.html">Recipes and rsample</a>
    </li>
    <li>
      <a href="../../articles/Applications/Time_Series.html">Time Series Analysis</a>
    </li>
    <li>
      <a href="../../articles/Applications/Survival_Analysis.html">Survival Analysis</a>
    </li>
    <li>
      <a href="../../articles/Applications/Nested_Resampling.html">Tuning Models using Nested Resampling</a>
    </li>
    <li>
      <a href="../../articles/Applications/Keras.html">Grid Search Tuning of Keras Models</a>
    </li>
    <li>
      <a href="../../articles/Applications/Intervals.html">Bootstrap Interval Estimation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidymodels/rsample/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Keras_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Grid Search Tuning of Keras Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/rsample/blob/master/vignettes/Applications/Keras.Rmd"><code>vignettes/Applications/Keras.Rmd</code></a></small>
      <div class="hidden name"><code>Keras.Rmd</code></div>

    </div>

    
    
<p>Here we demonstrate a simple grid search to optimize a tuning parameter of a <a href="https://keras.rstudio.com/index.html"><code>keras</code></a> neural network.</p>
<p>The Ames housing data is used to demonstrate. There are a number of predictors for these data but, for simplicity, we’ll see how far we can get by just using the geocodes for the properties as predictors of price. The outcome will be modeled on the log10 scale.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(AmesHousing)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3"></a>ames &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/AmesHousing/man/make_ames.html">make_ames</a></span>() <span class="op">%&gt;%</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(Sale_Price, Longitude, Latitude)</span></code></pre></div>
<p>To be consistent with other analyses of these data, a training/test split is made. However, this article focuses on the training set.</p>
<p>Normally, feature preprocessing should be estimated within the resampling process to get generalizable estimates of performance. Here, the two predictors are simply centered and scaled beforehand to avoid complexity in this analysis. However, this is generally a bad idea and the article on <a href="https://topepo.github.io/rsample/articles/Applications/Recipes_and_rsample.html"><code>recipes</code></a> describes a proper methodology for preprocessing the data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(rsample)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">4595</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>data_split &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/initial_split.html">initial_split</a></span>(ames, <span class="dt">strata =</span> <span class="st">"Sale_Price"</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a>ames_train &lt;-<span class="st"> </span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="st">  </span><span class="kw"><a href="../../reference/initial_split.html">training</a></span>(data_split) <span class="op">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Sale_Price =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log10</a></span>(Sale_Price),</span>
<span id="cb2-8"><a href="#cb2-8"></a>         <span class="dt">Longitude  =</span> <span class="kw"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(Longitude, <span class="dt">center =</span> <span class="ot">TRUE</span>),</span>
<span id="cb2-9"><a href="#cb2-9"></a>         <span class="dt">Latitude   =</span> <span class="kw"><a href="https://rdrr.io/r/base/scale.html">scale</a></span>(Latitude, <span class="dt">center =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p>The resample the model, simple 10-fold cross-validation is done such that the splits use the outcome as a stratification variable. On average, there should be 219 properties in the assessment set and this should be enough to obtain good estimates of the model RMSE.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2453</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a>cv_splits &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/vfold_cv.html">vfold_cv</a></span>(ames_train, <span class="dt">v =</span> <span class="dv">10</span>, <span class="dt">strata =</span> <span class="st">"Sale_Price"</span>)</span></code></pre></div>
<p>A single layer feed-forward neural network with 10 hidden units will be used to model these data. There are a great many tuning parameters for these models including those for structural aspects (e.g. number of hidden units, activation type, number of layers), the optimization (momentum, dropout rate, etc.), and so on. For simplicity, this article will only optimize the number of training epochs (i.e. iterations); basically this is testing for early stopping.</p>
<p>A function is needed to compute the model on the analysis set, predict the assessment set, and compute the holdout root mean squared error (in log10 units). The function below constructs the model sequentially and takes the number of epochs as a parameter. The argument <code>split</code> will be used to pass a single element of <code>cv_splits$splits</code>. This object will contain the two splits of the data for a single resample. The ellipses (<code>...</code>) will be used to pass arbitrary arguments to <code><a href="https://rdrr.io/pkg/keras/man/reexports.html">keras::fit</a></code>.</p>
<p>In this function, the seed is set. A few of the model components, such as <code>initializer_glorot_uniform</code> and <code>layer_dropout</code>, use random numbers and their specific seeds are set from the session’s seed. This helps with reproducibility.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(keras)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(yardstick)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>mlp_rmse &lt;-<span class="st"> </span><span class="cf">function</span>(epoch, split, ...) {</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="co"># Set the seed to get reproducible starting values and dropouts</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">4109</span>)</span>
<span id="cb4-8"><a href="#cb4-8"></a>  </span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="co"># Clearing the session after the computations have finished</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>  <span class="co"># clears memory used by the last trial in preparation for </span></span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="co"># the next iteration. </span></span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="kw"><a href="https://rdrr.io/r/base/on.exit.html">on.exit</a></span>(keras<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/backend.html">backend</a></span>()<span class="op">$</span><span class="kw">clear_session</span>())</span>
<span id="cb4-13"><a href="#cb4-13"></a>  </span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="co"># Define a single layer MLP with dropout and ReLUs</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>  model &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span>()</span>
<span id="cb4-16"><a href="#cb4-16"></a>  model <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(</span>
<span id="cb4-18"><a href="#cb4-18"></a>      <span class="dt">units =</span> <span class="dv">10</span>, </span>
<span id="cb4-19"><a href="#cb4-19"></a>      <span class="dt">activation =</span> <span class="st">'relu'</span>, </span>
<span id="cb4-20"><a href="#cb4-20"></a>      <span class="dt">input_shape =</span> <span class="dv">2</span>,</span>
<span id="cb4-21"><a href="#cb4-21"></a>      <span class="dt">kernel_initializer =</span> <span class="kw"><a href="https://rdrr.io/pkg/keras/man/initializer_glorot_uniform.html">initializer_glorot_uniform</a></span>()</span>
<span id="cb4-22"><a href="#cb4-22"></a>    ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span>(<span class="dt">rate =</span> <span class="fl">0.4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">1</span>, <span class="dt">activation =</span> <span class="st">"linear"</span>)</span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a>  model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/reexports.html">compile</a></span>(</span>
<span id="cb4-27"><a href="#cb4-27"></a>    <span class="dt">loss =</span> <span class="st">'mean_squared_error'</span>,</span>
<span id="cb4-28"><a href="#cb4-28"></a>    <span class="dt">optimizer =</span> <span class="kw"><a href="https://rdrr.io/pkg/keras/man/optimizer_rmsprop.html">optimizer_rmsprop</a></span>(),</span>
<span id="cb4-29"><a href="#cb4-29"></a>    <span class="dt">metrics =</span> <span class="st">'mean_squared_error'</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>  )</span>
<span id="cb4-31"><a href="#cb4-31"></a>  </span>
<span id="cb4-32"><a href="#cb4-32"></a>  <span class="co"># The data used for modeling (aka the "analysis" set)</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>  geocode &lt;-<span class="st"> </span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="st">    </span><span class="kw"><a href="../../reference/as.data.frame.rsplit.html">analysis</a></span>(split) <span class="op">%&gt;%</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>Sale_Price) <span class="op">%&gt;%</span></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>()</span>
<span id="cb4-37"><a href="#cb4-37"></a>  </span>
<span id="cb4-38"><a href="#cb4-38"></a>  model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/keras/man/reexports.html">fit</a></span>(</span>
<span id="cb4-39"><a href="#cb4-39"></a>    <span class="dt">x =</span> geocode, </span>
<span id="cb4-40"><a href="#cb4-40"></a>    <span class="dt">y =</span> <span class="kw"><a href="../../reference/as.data.frame.rsplit.html">analysis</a></span>(split)[[<span class="st">"Sale_Price"</span>]], </span>
<span id="cb4-41"><a href="#cb4-41"></a>    <span class="dt">epochs =</span> epoch,</span>
<span id="cb4-42"><a href="#cb4-42"></a>    ...</span>
<span id="cb4-43"><a href="#cb4-43"></a>    )</span>
<span id="cb4-44"><a href="#cb4-44"></a>  </span>
<span id="cb4-45"><a href="#cb4-45"></a>  <span class="co"># Now obtain the holdout set for prediction</span></span>
<span id="cb4-46"><a href="#cb4-46"></a>  holdout &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/as.data.frame.rsplit.html">assessment</a></span>(split)</span>
<span id="cb4-47"><a href="#cb4-47"></a>  pred_geocode &lt;-<span class="st"> </span></span>
<span id="cb4-48"><a href="#cb4-48"></a><span class="st">    </span>holdout <span class="op">%&gt;%</span></span>
<span id="cb4-49"><a href="#cb4-49"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>Sale_Price) <span class="op">%&gt;%</span></span>
<span id="cb4-50"><a href="#cb4-50"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>()</span>
<span id="cb4-51"><a href="#cb4-51"></a>  </span>
<span id="cb4-52"><a href="#cb4-52"></a>  <span class="co"># Get predicted values and compute RMSE</span></span>
<span id="cb4-53"><a href="#cb4-53"></a>  holdout <span class="op">%&gt;%</span></span>
<span id="cb4-54"><a href="#cb4-54"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">predicted =</span> <span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(model, pred_geocode)[,<span class="dv">1</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-55"><a href="#cb4-55"></a><span class="st">    </span><span class="kw"><a href="https://rdrr.io/pkg/yardstick/man/rmse.html">rmse</a></span>(<span class="dt">truth =</span> Sale_Price, <span class="dt">estimate =</span> predicted) <span class="op">%&gt;%</span></span>
<span id="cb4-56"><a href="#cb4-56"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(.estimate)</span>
<span id="cb4-57"><a href="#cb4-57"></a>}</span></code></pre></div>
<p>Let’s execute the function on the first fold of the data using a batch size of 128 and disable the print/plotting of the optimization:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>cv_splits<span class="op">$</span>splits[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## &lt;Training/Validation/Total&gt;
## &lt;1978/221/2199&gt;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">mlp_rmse</span>(</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="dt">epoch =</span> <span class="dv">100</span>,</span>
<span id="cb7-3"><a href="#cb7-3"></a>  cv_splits<span class="op">$</span>splits[[<span class="dv">1</span>]],</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="co"># now options to keras::fit</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="dt">batch_size =</span> <span class="dv">128</span>, </span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="dt">verbose =</span> <span class="dv">0</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>)</span></code></pre></div>
<pre><code>## [1] 0.3439176</code></pre>
<p>This works for a single resample and a single epoch setting. To tune over epochs, another function uses <code>map</code> to work over the tuning parameter for a specific resample. This is more advantageous than fixing the tuning parameter and then iterating over the data. If there was a complex feature engineering process being used, it only needs to be called once if functions are configured so that the <em>inner</em> loop is over the tuning parameters.</p>
<p>The result value is a tibble with the tuning parameter values, the performance estimates, and an indicator for the fold.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>across_grid &lt;-<span class="st"> </span><span class="cf">function</span>(split, ...) {</span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="co"># Create grid</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  epoch_values &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="dt">epoch =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">50</span>, <span class="dv">600</span>, <span class="dt">by =</span> <span class="dv">50</span>)) </span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="co"># Execute grid for this resample</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  epoch_values<span class="op">$</span>rmse &lt;-<span class="st"> </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span>(</span>
<span id="cb9-7"><a href="#cb9-7"></a>    epoch_values<span class="op">$</span>epoch, </span>
<span id="cb9-8"><a href="#cb9-8"></a>    mlp_rmse,</span>
<span id="cb9-9"><a href="#cb9-9"></a>    <span class="dt">split =</span> split, </span>
<span id="cb9-10"><a href="#cb9-10"></a>    <span class="co"># extra options for `fit`</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>    ...</span>
<span id="cb9-12"><a href="#cb9-12"></a>  )</span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="co"># Now attach the resample indicators using `labels`</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>  <span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(epoch_values, <span class="kw"><a href="https://rdrr.io/r/base/labels.html">labels</a></span>(split))</span>
<span id="cb9-15"><a href="#cb9-15"></a>}</span></code></pre></div>
<p>Note that the grid could easily have a been multidimensional so that many parameters could be optimized using a regular grid or via <a href="http://www.jmlr.org/papers/v13/bergstra12a.html">random search</a>. If that were the case, the candidate tuning parameter values could be in rows and the parameters in columns and <code>mlp_rmse</code> would then map the columns in the tibble to their respective arguments.</p>
<p><code>map_df</code> is used to operate over the folds. This will row-bind the resulting data frames together so that a single data set is assembled with the individual resampling results.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>tune_results &lt;-<span class="st"> </span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">  </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span>(</span>
<span id="cb10-3"><a href="#cb10-3"></a>    cv_splits<span class="op">$</span>splits,</span>
<span id="cb10-4"><a href="#cb10-4"></a>    across_grid,</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="dt">batch_size =</span> <span class="dv">128</span>, </span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="dt">verbose =</span> <span class="dv">0</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  )</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(tune_results)</span></code></pre></div>
<pre><code>##   epoch      rmse     id
## 1    50 1.6228076 Fold01
## 2   100 0.3565364 Fold01
## 3   150 0.3471868 Fold01
## 4   200 0.2139830 Fold01
## 5   250 0.2199497 Fold01
## 6   300 0.1786491 Fold01</code></pre>
<p>The mean RMSE per epoch is computed and plotted along with the individual curves for each resample.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>mean_values &lt;-<span class="st"> </span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span>tune_results <span class="op">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(epoch) <span class="op">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">rmse =</span> <span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(rmse))</span>
<span id="cb13-5"><a href="#cb13-5"></a>mean_values</span></code></pre></div>
<pre><code>## # A tibble: 12 x 2
##    epoch  rmse
##    &lt;dbl&gt; &lt;dbl&gt;
##  1    50 1.02 
##  2   100 0.437
##  3   150 0.307
##  4   200 0.236
##  5   250 0.206
##  6   300 0.174
##  7   350 0.155
##  8   400 0.150
##  9   450 0.150
## 10   500 0.149
## 11   550 0.149
## 12   600 0.149</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(mean_values, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> epoch, <span class="dt">y =</span> rmse)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">data =</span> tune_results, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">group =</span> id), <span class="dt">alpha =</span> <span class="fl">0.1</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span>(<span class="dt">trans =</span> <span class="st">"log2"</span>) <span class="op">+</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</span></code></pre></div>
<p><img src="Keras_files/figure-html/resample-means-1.png" width="768"></p>
<p>For this analysis, there doesn’t seem to be any overfitting issues with a large number of iterations (since the RMSE does not increase).</p>
<p><code>caret</code> includes some <a href="https://topepo.github.io/caret/train-models-by-tag.html#Neural_Network">pre-defined <code>keras</code> models</a> for single layer networks that can be used to optimize the model across a number of parameters.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="tidyverse">
  <p><code>rsample</code> is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Max Kuhn, Fanny Chow, <a href="http://hadley.nz">Hadley Wickham</a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
